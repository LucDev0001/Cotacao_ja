<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CotaçãoJá - Sistema Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-enter { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Botão de Instalar flutuante mobile */
        .install-btn-float {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);} 40% {transform: translateX(-50%) translateY(-10px);} 60% {transform: translateX(-50%) translateY(-5px);} }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <!-- BOTÃO DE INSTALAÇÃO (Invisível por padrão) -->
    <button id="btn-install-app" class="hidden install-btn-float bg-blue-900 text-white px-6 py-3 rounded-full shadow-2xl font-bold border-2 border-blue-400 flex items-center gap-2">
        <i data-lucide="download-cloud"></i> Instalar App
    </button>

    <!-- ======================================================= -->
    <!-- 1. LANDING PAGE -->
    <!-- ======================================================= -->
    <div id="landing-screen" class="flex-grow flex flex-col">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center bg-white shadow-sm">
            <div class="font-bold text-2xl text-blue-900 tracking-tighter flex items-center gap-2">
                <i data-lucide="shopping-bag" class="text-blue-600"></i> Cotação<span class="text-blue-500">Já</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="faq.html" class="text-slate-500 hover:text-blue-600 text-sm font-medium hidden sm:block">Como usar?</a>
                <button onclick="mostrarLogin()" class="text-blue-900 font-semibold hover:text-blue-600 transition text-sm border border-blue-200 px-4 py-2 rounded-full hover:bg-blue-50">Entrar</button>
            </div>
        </nav>

        <header class="flex-1 container mx-auto px-6 flex flex-col md:flex-row items-center justify-center gap-12 py-16">
            <div class="md:w-1/2 space-y-6 text-center md:text-left">
                <span class="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Gestão de Compras 2.0</span>
                <h1 class="text-4xl md:text-6xl font-extrabold leading-tight text-slate-900">
                    Conectando <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">Lojas e Fornecedores</span>.
                </h1>
                <p class="text-lg text-slate-600 md:max-w-lg leading-relaxed">
                    Gerencie pedidos, compare preços e feche negócios no WhatsApp. Tudo em tempo real.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start pt-4">
                    <button onclick="mostrarLogin()" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-xl shadow-blue-200 hover:bg-blue-700 transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                        Começar Agora <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                    <!-- Link Mobile para FAQ -->
                    <a href="faq.html" class="sm:hidden block text-blue-600 font-bold py-4 underline">Ver instruções de uso</a>
                </div>
            </div>
            
            <!-- Ilustração -->
            <div class="md:w-1/2 relative flex justify-center">
                <div class="absolute inset-0 bg-blue-200 rounded-full blur-3xl opacity-30 animate-pulse"></div>
                <div class="bg-white p-6 rounded-2xl shadow-2xl border border-slate-100 w-full max-w-sm relative z-10 transform rotate-1 hover:rotate-0 transition duration-500">
                    <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"><i data-lucide="package"></i></div>
                        <div>
                            <div class="text-sm font-bold text-slate-800">Pedido #4092</div>
                            <div class="text-xs text-slate-500">Aguardando ofertas</div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center">
                            <span class="text-sm font-medium">Fornecedor A</span>
                            <span class="text-sm font-bold text-green-600">R$ 150,00</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center opacity-60">
                            <span class="text-sm font-medium">Fornecedor B</span>
                            <span class="text-sm font-bold text-slate-400">R$ 165,00</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <!-- ======================================================= -->
    <!-- 2. LOGIN / CADASTRO -->
    <!-- ======================================================= -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-slate-100 fade-enter fixed inset-0 z-50 overflow-y-auto">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md relative my-8">
            <button onclick="voltarInicio()" class="absolute top-6 left-6 text-slate-400 hover:text-slate-600"><i data-lucide="arrow-left"></i></button>
            
            <div class="text-center mb-8 mt-2">
                <h2 class="text-2xl font-bold text-slate-800">Bem-vindo</h2>
                <p class="text-slate-500 text-sm">Acesse sua conta para continuar</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <input type="email" id="email" placeholder="E-mail" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <input type="password" id="password" placeholder="Senha" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                
                <div id="signup-fields" class="hidden space-y-4 pt-2 border-t border-slate-100 fade-enter">
                    <input type="text" id="nome" placeholder="Nome da Empresa/Pessoa" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <input type="tel" id="whatsapp" placeholder="WhatsApp (somente números)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <div class="relative">
                        <select id="tipoUser" class="w-full p-4 bg-white border border-slate-200 rounded-xl appearance-none text-slate-600">
                            <option value="fornecedor">Sou Fornecedor (Vender)</option>
                            <option value="gerente">Sou Gerente (Comprar)</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-4 text-slate-400 w-5 h-5 pointer-events-none"></i>
                    </div>
                </div>

                <button id="btn-action" onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition active:scale-95">Entrar</button>
            </div>
            
            <p class="text-center mt-6 text-sm text-slate-500">
                <button onclick="toggleAuthMode()" id="msg-toggle" class="text-blue-600 font-bold hover:underline">Criar nova conta</button>
            </p>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- 3. SISTEMA PRINCIPAL -->
    <!-- ======================================================= -->
    <div id="app-screen" class="hidden bg-slate-50 min-h-screen pb-24 fade-enter flex-col">
        
        <!-- App Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i data-lucide="grid" class="w-5 h-5"></i></div>
                    <div>
                        <h1 class="font-bold text-slate-800 leading-none">Painel</h1>
                        <p id="user-display" class="text-[10px] text-slate-500 font-medium uppercase tracking-wide mt-1">Carregando...</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition p-2"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <main class="container mx-auto px-4 max-w-2xl mt-6 flex-grow">
            
            <!-- FILTROS (Comum a todos) -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-slate-700">Itens</h3>
                <div class="relative">
                    <select id="filtro-categoria" onchange="aplicarFiltro()" class="pl-3 pr-8 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-600 focus:outline-none focus:border-blue-500">
                        <option value="todos">Todas Categorias</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Limpeza">Limpeza</option>
                        <option value="Hortifruti">Hortifruti</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            </div>

            <!-- VIEW GERENTE -->
            <div id="view-gerente" class="hidden space-y-6">
                <!-- Form Criar/Editar -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h2 id="form-title" class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="text-blue-600 w-5 h-5"></i> Novo Pedido
                    </h2>
                    
                    <input type="hidden" id="edit-id" value=""> <!-- ID oculto para edição -->

                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div class="col-span-2">
                            <input type="text" id="produtoInput" placeholder="Ex: 10kg Arroz" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="col-span-1">
                            <select id="categoriaInput" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none">
                                <option value="Outros">Categ.</option>
                                <option value="Alimentos">Aliment.</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Limpeza">Limpeza</option>
                                <option value="Hortifruti">Horti.</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="btn-save-pedido" onclick="salvarPedido()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/20">
                            Publicar Pedido
                        </button>
                        <button id="btn-cancel-edit" onclick="cancelarEdicao()" class="hidden px-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">
                            Cancelar
                        </button>
                    </div>
                </div>
                
                <div id="lista-gerente" class="space-y-4 pb-10"></div>
            </div>

            <!-- VIEW FORNECEDOR -->
            <div id="view-fornecedor" class="hidden space-y-6">
                <!-- Abas -->
                <div class="flex p-1 bg-slate-200 rounded-xl mb-4">
                    <button onclick="mudarAbaForn('oportunidades')" id="tab-oportunidades" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-blue-900 transition">Oportunidades</button>
                    <button onclick="mudarAbaForn('minhas')" id="tab-minhas" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 transition">Minhas Ofertas</button>
                </div>

                <div id="lista-fornecedor-todos" class="space-y-4 pb-10"></div>
                <div id="lista-fornecedor-minhas" class="hidden space-y-4 pb-10"></div>
            </div>

        </main>
    </div>

    <!-- RODAPÉ PROFISSIONAL -->
    <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
            <div>
                <h4 class="font-bold text-slate-800">CotaçãoJá</h4>
                <p class="text-xs text-slate-500 mt-1">Simplificando o comércio local.</p>
                <a href="faq.html" class="text-xs text-blue-600 underline mt-2 block">Central de Ajuda</a>
            </div>
            
            <div class="text-sm font-medium">
                Desenvolvido por <a href="https://lucianodevfrontend.netlify.app/" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold hover:underline transition">SantosCodes</a>
            </div>
        </div>
    </footer>

    <!-- LOGICA E FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc, updateDoc, deleteDoc, increment, serverTimestamp, collectionGroup, where, writeBatch } 
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // CONFIGURAÇÃO
        const firebaseConfig = {
            apiKey: "AIzaSyAhPYUnom0B7vXOjqf5eyMzye8f-Mp97Yw",
            authDomain: "leilaoreverso-af6e1.firebaseapp.com",
            projectId: "leilaoreverso-af6e1",
            storageBucket: "leilaoreverso-af6e1.firebasestorage.app",
            messagingSenderId: "1011226599836",
            appId: "1:1011226599836:web:e1f033e9ec9a1101896859"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserData = null;
        let allPedidos = []; 
        let myOffers = [];

        const initIcons = () => lucide.createIcons();
        window.addEventListener('load', initIcons);

        // --- PWA INSTALL LOGIC ---
        let deferredPrompt;
        const btnInstall = document.getElementById('btn-install-app');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Mostrar botão de instalação
            btnInstall.classList.remove('hidden');
        });

        btnInstall.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btnInstall.classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // REGISTER SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW Registrado!', reg))
            .catch(err => console.log('SW Falhou!', err));
        }

        // NAVEGAÇÃO
        window.mostrarLogin = () => {
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            btnInstall.classList.add('hidden'); // Esconder botão instalar no login
        }
        window.voltarInicio = () => {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('landing-screen').classList.remove('hidden');
            if (deferredPrompt) btnInstall.classList.remove('hidden'); // Mostrar novamente se disponível
        }

        // AUTH
        let isLoginMode = true;
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const fields = document.getElementById('signup-fields');
            const btn = document.getElementById('btn-action');
            const msg = document.getElementById('msg-toggle');
            
            if(!isLoginMode) {
                fields.classList.remove('hidden');
                btn.innerText = "Criar Conta Grátis";
                btn.onclick = cadastrar;
                msg.innerText = "Já tenho conta";
            } else {
                fields.classList.add('hidden');
                btn.innerText = "Entrar";
                btn.onclick = login;
                msg.innerText = "Criar nova conta";
            }
        }

        window.cadastrar = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const nome = document.getElementById('nome').value;
            const tipo = document.getElementById('tipoUser').value;
            const zap = document.getElementById('whatsapp').value;
            
            if(!email || !pass || !nome) return alert("Preencha todos os campos");
            
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", cred.user.uid), { nome, tipo, whatsapp: zap, email });
            } catch (e) { alert("Erro: " + e.message); }
        }

        window.login = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (e) { alert("Login inválido."); }
        }
        window.logout = () => signOut(auth);

        // STATE MANAGER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('landing-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('flex');
                btnInstall.classList.add('hidden'); // Esconder no App

                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    currentUserData.uid = user.uid;
                    document.getElementById('user-display').innerText = `${currentUserData.nome} • ${currentUserData.tipo.toUpperCase()}`;
                    iniciarApp(currentUserData.tipo);
                }
            } else {
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('flex');
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('landing-screen').classList.remove('hidden');
                if (deferredPrompt) btnInstall.classList.remove('hidden'); // Mostrar na Landing
                currentUserData = null;
            }
        });

        // APP CORE
        function iniciarApp(tipo) {
            const pedidosRef = collection(db, "pedidos");
            const q = query(pedidosRef, orderBy("createdAt", "desc"));

            document.getElementById('view-gerente').classList.add('hidden');
            document.getElementById('view-fornecedor').classList.add('hidden');

            // Listener Geral de Pedidos
            onSnapshot(q, (snapshot) => {
                allPedidos = [];
                snapshot.forEach(doc => allPedidos.push({ id: doc.id, ...doc.data() }));
                
                if (tipo === 'gerente') {
                    renderGerente();
                } else {
                    renderFornecedorOportunidades();
                }
            });

            if (tipo === 'gerente') {
                document.getElementById('view-gerente').classList.remove('hidden');
            } else {
                document.getElementById('view-fornecedor').classList.remove('hidden');
                // Listener Minhas Ofertas
                const myOffersQ = query(collectionGroup(db, 'ofertas'), where('fornecedorId', '==', currentUserData.uid));
                onSnapshot(myOffersQ, (snap) => {
                    myOffers = [];
                    snap.forEach(d => myOffers.push({ id: d.id, path: d.ref.path, ...d.data() }));
                    renderFornecedorMinhas();
                });
            }
        }

        // --- LÓGICA DE FILTRO ---
        window.aplicarFiltro = () => {
            if (currentUserData.tipo === 'gerente') renderGerente();
            else renderFornecedorOportunidades();
        }

        function filtrarDados(lista) {
            const categ = document.getElementById('filtro-categoria').value;
            if (categ === 'todos') return lista;
            return lista.filter(item => item.categoria === categ);
        }

        // --- GERENTE ---
        function renderGerente() {
            const container = document.getElementById('lista-gerente');
            container.innerHTML = '';
            const filtrados = filtrarDados(allPedidos);

            if(filtrados.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10">Nenhum pedido encontrado.</div>';
                return;
            }

            filtrados.forEach(data => {
                container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition relative group">
                        <div class="absolute top-4 right-4 flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editarPedido('${data.id}', '${data.produto}', '${data.categoria || 'Outros'}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100" title="Editar">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="apagarPedido('${data.id}')" class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100" title="Apagar">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase">${data.categoria || 'Geral'}</span>
                            <h4 class="font-bold text-slate-800 text-lg">${data.produto}</h4>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <span class="text-xs font-medium text-slate-500 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
                                ${data.ofertasCount || 0} ofertas recebidas
                            </span>
                            <button onclick="verOfertas('${data.id}')" id="btn-ver-${data.id}" class="text-sm font-bold text-blue-600 hover:underline">
                                Ver Ofertas
                            </button>
                        </div>
                        <div id="ofertas-${data.id}" class="hidden mt-4 space-y-2 bg-slate-50 p-3 rounded-xl border border-slate-100"></div>
                    </div>
                `;
            });
            initIcons();
        }

        window.salvarPedido = async () => {
            const inp = document.getElementById('produtoInput');
            const cat = document.getElementById('categoriaInput');
            const editId = document.getElementById('edit-id').value;
            const btn = document.getElementById('btn-save-pedido');

            if(!inp.value) return alert("Digite o nome do produto");
            btn.disabled = true;

            try {
                if (editId) {
                    await updateDoc(doc(db, "pedidos", editId), { produto: inp.value, categoria: cat.value });
                    alert("Pedido atualizado!");
                    cancelarEdicao();
                } else {
                    await addDoc(collection(db, "pedidos"), {
                        produto: inp.value, categoria: cat.value, createdAt: serverTimestamp(), status: 'aberto', ofertasCount: 0
                    });
                }
                inp.value = '';
            } catch(e) { console.error(e); alert("Erro ao salvar."); }
            finally { btn.disabled = false; }
        }

        window.editarPedido = (id, prod, cat) => {
            document.getElementById('produtoInput').value = prod;
            document.getElementById('categoriaInput').value = cat;
            document.getElementById('edit-id').value = id;
            document.getElementById('form-title').innerHTML = '<i data-lucide="pencil" class="text-orange-500 w-5 h-5"></i> Editando Pedido';
            document.getElementById('btn-save-pedido').innerText = "Atualizar Pedido";
            document.getElementById('btn-save-pedido').classList.replace('bg-blue-600', 'bg-orange-500');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            initIcons();
        }

        window.cancelarEdicao = () => {
            document.getElementById('produtoInput').value = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('categoriaInput').value = 'Outros';
            document.getElementById('form-title').innerHTML = '<i data-lucide="plus-circle" class="text-blue-600 w-5 h-5"></i> Novo Pedido';
            document.getElementById('btn-save-pedido').innerText = "Publicar Pedido";
            document.getElementById('btn-save-pedido').classList.replace('bg-orange-500', 'bg-blue-600');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            initIcons();
        }

        window.apagarPedido = async (id) => {
            if(confirm("Tem certeza?")) await deleteDoc(doc(db, "pedidos", id));
        }

        window.verOfertas = (id) => {
            const div = document.getElementById(`ofertas-${id}`);
            const btn = document.getElementById(`btn-ver-${id}`);
            if(!div.classList.contains('hidden')) {
                div.classList.add('hidden'); btn.innerText = "Ver Ofertas"; return;
            }
            div.classList.remove('hidden'); btn.innerText = "Ocultar";
            div.innerHTML = '<p class="text-xs text-center text-slate-400">Carregando...</p>';
            
            const q = query(collection(db, "pedidos", id, "ofertas"), orderBy("valor", "asc"));
            onSnapshot(q, (snap) => {
                div.innerHTML = '';
                if(snap.empty) { div.innerHTML = '<p class="text-xs text-slate-400 text-center">Sem ofertas.</p>'; return; }
                snap.forEach(o => {
                    const off = o.data();
                    div.innerHTML += `
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-slate-100">
                            <div><div class="font-bold text-green-600">R$ ${off.valor.toFixed(2)}</div><div class="text-[10px] text-slate-500 uppercase">${off.fornecedorNome}</div></div>
                            <a href="https://wa.me/${off.whatsapp}?text=Olá ${off.fornecedorNome}, aceito a oferta de R$${off.valor} para o pedido." target="_blank"
                               class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition flex items-center gap-1 text-xs font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> WhatsApp</a>
                        </div>
                    `;
                });
                initIcons();
            })
        }

        // --- FORNECEDOR ---
        window.mudarAbaForn = (aba) => {
            const listaTodos = document.getElementById('lista-fornecedor-todos');
            const listaMinhas = document.getElementById('lista-fornecedor-minhas');
            const btnOp = document.getElementById('tab-oportunidades');
            const btnMy = document.getElementById('tab-minhas');

            if (aba === 'oportunidades') {
                listaTodos.classList.remove('hidden'); listaMinhas.classList.add('hidden');
                btnOp.classList.add('bg-white', 'shadow-sm', 'text-blue-900'); btnOp.classList.remove('text-slate-500');
                btnMy.classList.remove('bg-white', 'shadow-sm', 'text-blue-900'); btnMy.classList.add('text-slate-500');
                renderFornecedorOportunidades();
            } else {
                listaTodos.classList.add('hidden'); listaMinhas.classList.remove('hidden');
                btnMy.classList.add('bg-white', 'shadow-sm', 'text-blue-900'); btnMy.classList.remove('text-slate-500');
                btnOp.classList.remove('bg-white', 'shadow-sm', 'text-blue-900'); btnOp.classList.add('text-slate-500');
                renderFornecedorMinhas();
            }
        }

        function renderFornecedorOportunidades() {
            const container = document.getElementById('lista-fornecedor-todos');
            container.innerHTML = '';
            const filtrados = filtrarDados(allPedidos);

            if(filtrados.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 mt-10">Nenhum pedido disponível.</div>'; return; }

            filtrados.forEach(data => {
                container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-orange-500 hover:shadow-md transition">
                        <div class="flex justify-between mb-3">
                            <h4 class="font-bold text-slate-800 text-lg">${data.produto}</h4>
                            <span class="text-[10px] font-bold uppercase bg-slate-100 px-2 py-1 rounded text-slate-500 h-fit">${data.categoria || 'Geral'}</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="valor-${data.id}" placeholder="Preço (R$)" class="flex-1 p-3 border border-slate-200 rounded-xl text-sm outline-none focus:border-orange-500">
                            <button onclick="enviarOferta('${data.id}')" class="bg-orange-500 text-white px-5 rounded-xl font-bold shadow hover:bg-orange-600 transition">Enviar</button>
                        </div>
                    </div>
                `;
            });
        }

        function renderFornecedorMinhas() {
            const container = document.getElementById('lista-fornecedor-minhas');
            container.innerHTML = '';
            if(myOffers.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 mt-10">Você ainda não fez ofertas.</div>'; return; }

            myOffers.forEach(offer => {
                const produtoRelacionado = allPedidos.find(p => p.id === offer.path.split('/')[1]);
                const nomeProduto = produtoRelacionado ? produtoRelacionado.produto : "Pedido encerrado/desconhecido";
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-3 flex justify-between items-center">
                        <div>
                            <div class="text-xs text-slate-400 mb-1">Para: ${nomeProduto}</div>
                            <div class="font-bold text-green-600 text-xl flex items-center gap-2">R$ <input type="number" id="edit-val-${offer.id}" value="${offer.valor}" class="w-24 border-b border-slate-300 focus:outline-none focus:border-green-500 bg-transparent"></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="atualizarMinhaOferta('${offer.path}', '${offer.id}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100"><i data-lucide="save" class="w-4 h-4"></i></button>
                            <button onclick="apagarMinhaOferta('${offer.path}', '${offer.path.split('/')[1]}')" class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
            });
            initIcons();
        }

        window.enviarOferta = async (pedidoId) => {
            const val = document.getElementById(`valor-${pedidoId}`).value;
            if(!val) return;
            try {
                await addDoc(collection(db, "pedidos", pedidoId, "ofertas"), {
                    valor: parseFloat(val), fornecedorId: currentUserData.uid, fornecedorNome: currentUserData.nome, whatsapp: currentUserData.whatsapp, createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, "pedidos", pedidoId), { ofertasCount: increment(1) });
                alert("Oferta enviada!"); document.getElementById(`valor-${pedidoId}`).value = '';
            } catch(e) { console.error(e); alert("Erro ao enviar."); }
        }

        window.atualizarMinhaOferta = async (path, elementId) => {
            const novoValor = document.getElementById(`edit-val-${elementId}`).value;
            const parts = path.split('/');
            try { await updateDoc(doc(db, parts[0], parts[1], parts[2], parts[3]), { valor: parseFloat(novoValor) }); alert("Preço atualizado!"); } catch(e) { alert("Erro ao atualizar."); }
        }

        window.apagarMinhaOferta = async (path, parentId) => {
            if(!confirm("Remover esta oferta?")) return;
            const parts = path.split('/');
            try { await deleteDoc(doc(db, parts[0], parts[1], parts[2], parts[3])); await updateDoc(doc(db, "pedidos", parentId), { ofertasCount: increment(-1) }); } catch(e) { alert("Erro ao apagar."); }
        }
    </script>
</body>
</html>


